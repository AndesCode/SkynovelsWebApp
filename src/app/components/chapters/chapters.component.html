<ng-template #createRatingModal>
    <!--First div defines custom widht for the modal dialog-->
    <div class="skn-dialong-modal" style="max-width: 45rem;">
        <div class="modal-header">
            <h4 class="modal-title">Tu calificación</h4>
        </div>
        <div class="modal-body">
            <form autocomplete="off" [formGroup]="newRatingForm">
                <div style="display: flex;">
                    <span style="margin-right: 5px" class="skn-text">Puntuación:</span>
                    <ngb-rating formControlName="rate_value" style="border: none !important; outline: none !important;" [max]="5">
                        <ng-template let-fill="fill" let-index="index">
                            <span class="star" [class.filled]="fill === 100" [class.nfilled]="fill !== 100">
                            <span class="half" [style.width.%]="fill">
                                <i class="material-icons"></i>
                            </span>
                            </span>
                        </ng-template>
                    </ngb-rating>
                </div>
                <mat-form-field style="width: 100%;">
                    <mat-label>Comentario</mat-label>
                    <textarea matInput cdkTextareaAutosize #autosize="cdkTextareaAutosize" cdkAutosizeMinRows="1" cdkAutosizeMaxRows="10" placeholder="Escribe un comentario" formControlName="rate_comment"></textarea>
                </mat-form-field>
            </form>
        </div>
        <div class="modal-footer">
            <button mat-raised-button class="skn-cancel-button" style="margin-right: 15px;" (click)="dialog.closeAll()">Cancelar</button>
            <button mat-raised-button color="primary" (click)="createNovelRating(); dialog.closeAll()" [disabled]="newRatingForm.invalid">Publicar</button>
        </div>
    </div>
</ng-template>
<ng-template #deleteBookmark>
    <div class="skn-bottom-sheet-modal">
        <div class="modal-header">
            <h4 class="modal-title">Eliminar de lista de lectura</h4>
        </div>
        <div class="skn-bottomSheet-buttons" style="padding: 1rem 1rem">
            <div>
                <button mat-raised-button class="skn-cancel-button" (click)="bottomSheet.dismiss()">Cancelar</button>
            </div>
            <div>
                <button mat-raised-button color="warn" (click)="switchBookMark(); bottomSheet.dismiss()">Eliminar</button>
            </div>
        </div>
    </div>
</ng-template>
<ng-template #allChapters>
    <div style="max-width: 25em!important; max-height: 72vh!important;">
        <div class="skn-all-chapters-nav">
            <div class="skn-modal-top-close-button">
                <button mat-icon-button (click)="dialog.closeAll()" [attr.aria-label]="'close'">
                    <span class="material-icons skn-text">close</span>
                </button>
            </div>
            <h4 class="modal-title" style="margin: 12px;">Todos los capitulos</h4>
        </div>
        <div class="modal-body">
            <div class="skn-nvl-vlm-chapters-container row">
                <div class="skn-nvl-chp-element skn-text skn-secondary skn-secondary-hover" *ngFor="let chapter of novel.chapters" (click)="loadNovelDataChapters(chapter.id); dialog.closeAll();">
                    <div class="skn-nvl-chp-element-chp-number-index">
                        {{chapter.chp_number}}
                    </div>
                    <div>
                        <div class="skn-nvl-chp-element-title"> {{ps.setContent(chapter.chp_index_title, 69)}}</div>
                        <small>{{hs.getRelativeTime(chapter.createdAt).message}}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</ng-template>
<nav class="skn-main skn-reading-navbar" *ngIf="LoadedChapters.length > 0">
    <div class="skn-reading-navbar-logo-container">
        <div class="skn-reading-navbar-logo" (click)="goToHome()"></div>
    </div>
    <div class="skn-reading-navbar-elements">
        <div class="skn-navbar-left-elements">
            <h3 class="skn-link" style="margin-right: 5px;" (click)="goToNovel()" *ngIf="!mobile">{{novel.nvl_title}} -</h3>
            <h3 *ngIf="!mobile">{{novel.nvl_currentChapter}}</h3>
            <small class="skn-link" *ngIf="mobile" (click)="goToNovel()" style="margin-top: 5px;"><strong>{{novel.nvl_acronym}} / {{novel.nvl_currentChapterN}}</strong></small>
        </div>
        <div class="skn-navbar-right-elements">
            <button mat-button (click)="openBottomSheet(userOptionsModal)"><span class="material-icons">menu</span></button>
        </div>
    </div>
</nav>
<div class="skn-chp-main-panel" #mainpanel>
    <div class="container skn-main" #infiniteScroll infiniteScroll [infiniteScrollDistance]="0" [infiniteScrollThrottle]="50" [infiniteScrollContainer]="selector" [fromRoot]="true" (scrolledUp)="onScrollUp()" *ngIf="LoadedChapters.length > 0">
        <div class="skn-chapter-loading" *ngIf="loading || LoadedChapters.length === 0">
            <mat-spinner></mat-spinner>
        </div>
        <div class="skn-chp-novel-portrait" *ngIf="loadPortrait">
            <div class="skn-chp-novel-portrait-image">
                <img [src]="novel.nvl_img | noimage" alt="">
            </div>
            <div>
                <h2>{{novel.nvl_title}}</h2>
            </div>
            <div>
                <h2>Autor: {{novel.nvl_writer}}</h2>
            </div>
            <div class="skn-chp-novel-portrait-signing">
                <div class="skn-chp-novel-portrait-signing-img"></div>
                <div>
                    <h4 style="margin: 0px;">SkyNovels</h4>
                </div>
            </div>
            <hr>
        </div>
        <div #chaptersElement class="skn-chp-chapter" *ngFor="let LoadedChapter of LoadedChapters;">
            <div class="skn-hide">
                <div>
                    <div>{{LoadedChapter.chp_name}}</div>
                    <div>{{LoadedChapter.chp_index_title}}</div>
                </div>
                <div>
                    <div>{{LoadedChapter.id}}</div>
                    <div>{{LoadedChapter.chp_number}}</div>
                </div>
            </div>
            <div class="skn-chp-chapter-title">
                <h1>{{LoadedChapter.chp_title}}</h1>
            </div>
            <div class="skn-chp-chapter-translator" *ngIf="LoadedChapter.chp_translator">
                <small>Traductor: <strong>{{LoadedChapter.chp_translator}}</strong></small>
            </div>
            <div class="skn-chp-chapter-translator_eng" *ngIf="LoadedChapter.chp_translator_eng">
                <small>Traductor al ingles: <strong>{{LoadedChapter.chp_translator_eng}}</strong></small>
            </div>
            <div class="skn-chp-chapter-content">
                <p [innerHTML]="LoadedChapter.chp_content"></p>
            </div>
            <hr>
            <div class="autor_comment" *ngIf="LoadedChapter.chp_review">
                <h3 class="autor_comment_title" *ngIf="LoadedChapter.chp_translator"><span class="material-icons md-36">mode_comment</span>Comentario de {{LoadedChapter.chp_translator}}</h3>
                <p [innerHTML]="LoadedChapter.chp_review"></p>
            </div>
            <hr>
            <div class="skn-chp-chapter-preloaded-comments">
                <p style="margin-bottom: 20px;"><strong>Comentarios: ({{LoadedChapter.comments?.length}})</strong></p>


                <div class="skn-nvl-user-rating skn-secondary" *ngFor="let comment of LoadedChapter.comments | slice: 0:3">
                    <div class="skn-user-image">
                        <div>
                            <img src="https://dummyimage.com/50x50/000/fff" alt="">
                        </div>
                    </div>
                    <div class="skn-nvl-user-rating-user-rating">
                        <div class="skn-nvl-user-rating-login">
                            <div style="display: flex;">
                                <div class="skn-user-image-mobile">
                                    <div>
                                        <img src="https://dummyimage.com/50x50/000/fff" alt="">
                                    </div>
                                </div>
                                <strong style="margin: auto 6px">{{comment.user_login}}</strong>
                            </div>
                            <button mat-mini-fab *ngIf="!comment.edition && user?.id === comment.user_id" [matMenuTriggerFor]="userMenu"><span class="material-icons">more_vert</span></button>
                            <mat-menu #userMenu="matMenu">
                                <button mat-menu-item (click)="ps.setEdition(comment)">
                                  <span>Editar</span>
                                </button>
                                <button mat-menu-item (click)="openDialogSheet(deleteCommentModal)">
                                  <span>Eliminar</span>
                                </button>
                            </mat-menu>
                            <button mat-mini-fab *ngIf="comment.edition" (click)="ps.updateCommentFunction(updateCommentForm, comment)"><span class="material-icons">done</span></button>
                        </div>
                        <hr>
                        <div>
                            <p [innerHTML]="ps.setContent(comment.comment_content, 160)" *ngIf="(!comment.show_more && comment.comment_content.length > 160) && !comment.edition"></p>
                            <p [innerHTML]="comment.comment_content" *ngIf="(comment.show_more || comment.comment_content.length < 160) && !comment.edition"></p>
                            <form autocomplete="off" #updateCommentForm="ngForm">
                                <div class="form-group" style="width: 100%;" *ngIf="comment.edition">
                                    <textarea class="form-control skn-text-area" id="exampleFormControlTextarea1" #comment_content="ngModel" name="comment.comment_content" [(ngModel)]="comment.comment_content" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <div *ngIf="comment.comment_content.length <= 160"></div>
                            <div *ngIf="comment.comment_content.length > 160 && !comment.edition">
                                <strong class="skn-link skn-text" (click)="ps.showMore(comment)">{{comment.show_more ? '...Mostrar menos' : '...Ver más'}}</strong>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <button mat-icon-button aria-label="like" (click)="ps.switchLike(user, comment, 'comment_id')">
                                    <span class="material-icons skn-like" [ngClass]="{'liked': comment.liked}">thumb_up</span>
                                </button>
                                <div style="margin-top: 3px;">{{comment.likes?.length}}</div>
                            </div>
                        </div>
                    </div>
                    <ng-template #deleteCommentModal>
                        <div class="modal-header">
                            <h4 class="modal-title">Eliminar tu comentario</h4>
                        </div>
                        <div class="modal-body">
                            <p>¿Seguro que deseas eliminar el comentario?</p>
                        </div>
                        <div class="modal-footer">
                            <button mat-raised-button class="skn-cancel-button" style="margin-right: 15px;" (click)="dialog.closeAll()">Cancelar</button>
                            <button mat-raised-button color="warn" (click)="ps.deleteCommentFunction(LoadedChapter, comment); dialog.closeAll()">Eliminar</button>
                        </div>
                    </ng-template>
                </div>
            </div>
            <div class="skn-chp-chapter-allCommentsButton">
                <button mat-raised-button color="primary" (click)="openBottomSheet(chapterCommentsModal)" *ngIf="mobile">Todos los comentarios</button>
                <button mat-raised-button color="primary" (click)="openBottomSheet(chapterCommentsModal)" *ngIf="!mobile">Todos los comentarios</button>
            </div>



            <ng-template #chapterCommentsModal>
                <div class="skn-all-comments-content">
                    <div class="skn-chapter-comment-top-nav">
                        <div class="skn-modal-top-close-button">
                            <button mat-icon-button (click)="bottomSheet.dismiss()" [attr.aria-label]="'close'">
                                <span class="material-icons skn-text">close</span>
                            </button>
                        </div>
                    </div>
                    <div class="skn-chapter-comment-content">
                        <div *ngIf="LoadedChapter.comments.length === 0" class="skn-chp-no-comments">
                            <h1>No hay comentarios</h1>
                        </div>
                        <div class="skn-nvl-user-rating skn-secondary" *ngFor="let comment of LoadedChapter.comments">
                            <div class="skn-user-image">
                                <div>
                                    <img src="https://dummyimage.com/50x50/000/fff" alt="">
                                </div>
                            </div>
                            <div class="skn-nvl-user-rating-user-rating">
                                <div class="skn-nvl-user-rating-login">
                                    <div style="display: flex;">
                                        <div class="skn-user-image-mobile">
                                            <div>
                                                <img src="https://dummyimage.com/50x50/000/fff" alt="">
                                            </div>
                                        </div>
                                        <strong style="margin: auto 6px">{{comment.user_login}}</strong>
                                    </div>
                                    <button mat-mini-fab *ngIf="!comment.edition && user?.id === comment.user_id" [matMenuTriggerFor]="userMenu"><span class="material-icons">more_vert</span></button>
                                    <mat-menu #userMenu="matMenu">
                                        <button mat-menu-item (click)="ps.setEdition(comment)">
                                          <span>Editar</span>
                                        </button>
                                        <button mat-menu-item (click)="openDialogSheet(deleteCommentModal)">
                                          <span>Eliminar</span>
                                        </button>
                                    </mat-menu>
                                    <button mat-mini-fab *ngIf="comment.edition" (click)="ps.updateCommentFunction(updateCommentForm, comment)"><span class="material-icons">done</span></button>
                                </div>
                                <hr>
                                <div>
                                    <p [innerHTML]="ps.setContent(comment.comment_content, 160)" *ngIf="(!comment.show_more && comment.comment_content.length > 160) && !comment.edition"></p>
                                    <p [innerHTML]="comment.comment_content" *ngIf="(comment.show_more || comment.comment_content.length < 160) && !comment.edition"></p>
                                    <form autocomplete="off" #updateCommentForm="ngForm">
                                        <div class="form-group" style="width: 100%;" *ngIf="comment.edition">
                                            <textarea class="form-control skn-text-area" id="exampleFormControlTextarea1" #comment_content="ngModel" name="comment.comment_content" [(ngModel)]="comment.comment_content" rows="3"></textarea>
                                        </div>
                                    </form>
                                </div>
                                <div *ngIf="comment.comment_content.length > 160 && !comment.edition">
                                    <strong class="skn-link skn-text" (click)="ps.showMore(comment)">{{comment.show_more ? '...Mostrar menos' : '...Ver más'}}</strong>
                                </div>
                                <br>

                                <div style="display: flex; justify-content: space-between;">
                                    <div>
                                        <span class="skn-link skn-red-text" *ngIf="!comment.show_replys" (click)="ps.getReplysFunction(user, comment, 'comment_id')">Respuestas</span>
                                        <span class="skn-link skn-red-text" *ngIf="comment.show_replys" (click)="ps.hideReplys(comment)">Ocultar Respuestas</span>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <button mat-icon-button aria-label="like" (click)="ps.switchLike(user, comment, 'comment_id')">
                                            <span class="material-icons skn-like" [ngClass]="{'liked': comment.liked}">thumb_up</span>
                                        </button>
                                        <div style="margin-top: 3px;">{{comment.likes?.length}}</div>
                                    </div>
                                </div>
                                <hr>





                                <div *ngIf="comment.show_replys">
                                    <form *ngIf="user">
                                        <div class="skn-nvl-rating-comment-textarea" style="align-items: unset;">
                                            <div class="skn-user-image" style="margin-right: 15px;">
                                                <div>
                                                    <img src="https://dummyimage.com/50x50/000/fff" alt="">
                                                </div>
                                            </div>
                                            <div class="skn-nvl-rating-comment-textarea-input">
                                                <mat-form-field style="width: 100%;">
                                                    <mat-label>Responder a {{comment.user_login}}</mat-label>
                                                    <textarea matInput cdkTextareaAutosize #autosize="cdkTextareaAutosize" cdkAutosizeMinRows="1" cdkAutosizeMaxRows="10" #reply="ngModel" name="comment.reply" [(ngModel)]="comment.reply"></textarea>
                                                </mat-form-field>
                                            </div>
                                            <button class="skn-nvl-rating-comment-textarea-button" mat-raised-button color="primary" (click)="ps.createReplyFunction(user, comment, 'comment_id')">Publicar</button>
                                        </div>
                                    </form>
                                    <div class="skn-nvl-user-rating" *ngFor="let reply of comment.replys" style="padding: 0px!important;">
                                        <div class="skn-user-image">
                                            <div>
                                                <img src="https://dummyimage.com/50x50/000/fff" alt="">
                                            </div>
                                        </div>
                                        <div class="skn-nvl-user-rating-user-rating">
                                            <div class="skn-nvl-user-rating-login" style="margin-bottom: 5px;">
                                                <div style="display: flex;">
                                                    <div class="skn-user-image-mobile">
                                                        <div>
                                                            <img src="https://dummyimage.com/50x50/000/fff" alt="">
                                                        </div>
                                                    </div>
                                                    <div class="skn-nvl-user-rating-login-name">
                                                        <strong style="margin-right: 5px;">{{reply.user_login}}</strong>
                                                        <small>{{reply.date_data.message}}</small>
                                                    </div>
                                                </div>
                                                <button mat-mini-fab *ngIf="!reply.edition && user?.id === reply.user_id" [matMenuTriggerFor]="userMenu"><i class="material-icons">more_vert</i></button>
                                                <mat-menu #userMenu="matMenu">
                                                    <button mat-menu-item (click)="ps.setEdition(reply)">
                                                      <span>Editar</span>
                                                    </button>
                                                    <button mat-menu-item (click)="openDialogSheet(deleteCommentReplyModal)">
                                                      <span>Eliminar</span>
                                                    </button>
                                                </mat-menu>
                                                <button mat-mini-fab *ngIf="reply.edition && user?.id === reply.user_id" (click)="ps.updateReplyFunction(updateReplyForm, reply)"><i class="material-icons">done</i></button>
                                            </div>
                                            <div>
                                                <p [innerHTML]="ps.setContent(reply.reply_content, 360)" *ngIf="(!reply.show_more && reply.reply_content.length > 360) && !reply.edition"></p>
                                                <p [innerHTML]="reply.reply_content" *ngIf="(reply.show_more || reply.reply_content.length < 360) && !reply.edition"></p>
                                                <form autocomplete="off" #updateReplyForm="ngForm">
                                                    <div class="form-group" *ngIf="reply.edition" style="width: 100%;">
                                                        <textarea class="form-control skn-text-area" #reply_content="ngModel" name="rating_comment.reply_content" [(ngModel)]="reply.reply_content" rows="3" required maxlength="2000" minlength="2"></textarea>
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="d-flex" [ngClass]="{'justify-content-end': reply.reply_content.length < 360 || reply.edition, 'justify-content-between': reply.reply_content.length > 360 || reply.edition}">
                                                <div *ngIf="reply.reply_content.length > 360 && !reply.edition">
                                                    <strong class="skn-link skn-text" (click)="ps.showMore(reply)">{{reply.show_more ? '...Mostrar menos' : '...Ver más'}}</strong>
                                                </div>
                                                <div style="display: flex; align-items: center;">
                                                    <button mat-icon-button aria-label="like" (click)="ps.switchLike(user, reply, 'reply_id')">
                                                        <span class="material-icons skn-like" [ngClass]="{'liked': reply.liked}">thumb_up</span>
                                                    </button>
                                                    <div style="margin-top: 3px;">{{reply.likes?.length}}</div>
                                                </div>
                                            </div>
                                            <hr>
                                        </div>
                                        <ng-template #deleteCommentReplyModal>
                                            <div class="skn-dialong-modal">
                                                <div class="modal-header">
                                                    <h4 class="modal-title">Eliminar tu comentario</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <p>¿Seguro que deseas eliminar el comentario?</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button mat-raised-button class="skn-cancel-button" style="margin-right: 15px;" (click)="dialog.closeAll()">Cancelar</button>
                                                    <button mat-raised-button color="warn" style="color: black;" (click)="ps.deleteReplyFunction(comment, reply); dialog.closeAll()">Eliminar</button>
                                                </div>
                                            </div>
                                        </ng-template>
                                    </div>
                                </div>
                            </div>
                            <ng-template #deleteCommentModal>
                                <div class="modal-header">
                                    <h4 class="modal-title">Eliminar tu comentario</h4>
                                </div>
                                <div class="modal-body">
                                    <p>¿Seguro que deseas eliminar el comentario?</p>
                                </div>
                                <div class="modal-footer">
                                    <button mat-raised-button class="skn-cancel-button" style="margin-right: 15px;" (click)="dialog.closeAll()">Cancelar</button>
                                    <button mat-raised-button color="warn" (click)="ps.deleteCommentFunction(LoadedChapter, comment); dialog.closeAll()">Eliminar</button>
                                </div>
                            </ng-template>
                        </div>
                    </div>
                    <div class="skn-chapter-comment-nav">
                        <form *ngIf="user" #commentForm="ngForm">
                            <div class="skn-nvl-rating-comment-textarea">
                                <div class="skn-user-image" style="margin-right: 15px;">
                                    <div>
                                        <img src="https://dummyimage.com/50x50/000/fff" alt="">
                                    </div>
                                </div>
                                <div class="skn-nvl-rating-comment-textarea-input">
                                    <mat-form-field style="width: 100%;">
                                        <mat-label>Añade un comentario</mat-label>
                                        <textarea matInput cdkTextareaAutosize #autosize="cdkTextareaAutosize" cdkAutosizeMinRows="1" cdkAutosizeMaxRows="4" #comment="ngModel" name="LoadedChapter.comment" [(ngModel)]="LoadedChapter.comment" required minlength="2"></textarea>
                                    </mat-form-field>
                                </div>
                                <button class="skn-nvl-rating-comment-textarea-button" mat-mini-fab color="primary" class="skn-primary-button" [disabled]="commentForm.invalid" (click)="ps.createCommentFunction(user, LoadedChapter, 'chp_id')"><span class="material-icons">send</span></button>
                            </div>
                        </form>
                    </div>
                </div>
            </ng-template>
            <hr>
        </div>
        <div class="skn-chapter-loading" *ngIf="loading">
            <mat-spinner></mat-spinner>
        </div>
        <div inViewport [inViewportOptions]="{ threshold: 5 }" (inViewportAction)="onScrollDown($event)" style="height: 50px;" *ngIf="LoadedChapters.length > 0"></div>
    </div>
    <div class="skn-loading" *ngIf="LoadedChapters.length === 0">
        <mat-spinner></mat-spinner>
    </div>
</div>
<ng-template #userOptionsModal>
    <div class="skn-bottom-sheet-modal">
        <div class="skn-bottomSheet-buttons" style="padding: 1rem 1rem">
            <div>
                <button mat-raised-button color="primary" (click)="toggleTheme();" class="hide-dark">Modo día</button>
                <button mat-raised-button color="primary" (click)="toggleTheme();" class="hide-light">Modo noche</button>
                <button mat-raised-button color="primary" (click)="openDialogSheet(createRatingModal); bottomSheet.dismiss()" *ngIf="user && !novel.nvl_rated">Calificar novela</button>
                <button mat-raised-button color="primary" (click)="openDialogSheet(allChapters); bottomSheet.dismiss()">Lista de capitulos</button>
                <button mat-raised-button color="primary" *ngIf="!user" (click)="openLoginForm(); bottomSheet.dismiss()">Iniciar Sesión</button>
                <button mat-raised-button color="primary" *ngIf="user && !novel.user_bookmark" (click)="switchBookMark()">Agregar a lista de lectura</button>
                <button mat-raised-button color="primary" *ngIf="user && novel.user_bookmark" (click)="openBottomSheet(deleteBookmark)">Quitar a lista de lectura</button>
                <button mat-raised-button class="skn-cancel-button" (click)="bottomSheet.dismiss()">Cerrar</button>
            </div>
        </div>
    </div>
</ng-template>
<ng-template #successSnack>
    <div class="skn-snack-success-notification">
        <div class="skn-snack-notification-text">{{successSnackMessage}}</div>
        <div>
            <button mat-icon-button (click)="matSnackBar.dismiss()">
                <span class="material-icons">close</span>
            </button>
        </div>
    </div>
</ng-template>
<ng-template #errorSnack>
    <div class="skn-snack-error-notification">
        <div class="skn-snack-notification-text">{{errorSnackMessage}}</div>
        <div>
            <button mat-icon-button (click)="matSnackBar.dismiss()">
                <span class="material-icons">close</span>
            </button>
        </div>
    </div>
</ng-template>